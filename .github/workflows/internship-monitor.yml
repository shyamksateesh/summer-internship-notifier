name: Internship Monitor

on:
  schedule:
    # Runs every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch: # Allows manual triggering for testing

jobs:
  check-for-updates:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout monitoring repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Fetch latest internship data
        run: |
          # Fetch the FULL README directly from the raw GitHub content
          curl -L \
               -o new_readme.md \
               https://raw.githubusercontent.com/SimplifyJobs/Summer2026-Internships/dev/README.md
          
          # Fetch the last commit info for the README
          curl -H "Accept: application/vnd.github.v3+json" \
               -o latest_commit.json \
               https://api.github.com/repos/SimplifyJobs/Summer2026-Internships/commits?path=README.md&per_page=1
      
      - name: Analyze changes and detect new internships
        id: analyze
        run: |
          python3 << 'PYTHON_SCRIPT'
          import re
          import json
          import sys
          from datetime import datetime
          
          print("Starting analysis...")
          
          # Read the previous and new README files
          try:
              with open('previous_readme.md', 'r', encoding='utf-8') as f:
                  previous_content = f.read()
              print(f"Previous README loaded: {len(previous_content)} characters")
          except FileNotFoundError:
              print("First run - no previous data")
              previous_content = ""
          
          with open('new_readme.md', 'r', encoding='utf-8') as f:
              new_content = f.read()
          print(f"New README loaded: {len(new_content)} characters")
          
          # Read commit info
          with open('latest_commit.json', 'r') as f:
              commit_data = json.load(f)[0]
              commit_message = commit_data['commit']['message']
              commit_date = commit_data['commit']['author']['date']
              commit_sha = commit_data['sha'][:7]
          
          print(f"Commit info: {commit_sha} - {commit_message}")
          
          def extract_section(content, section_title):
              """Extract a specific section from the README - FAST VERSION"""
              print(f"Extracting section: {section_title}")
              
              # Try multiple patterns to handle emoji encoding differences
              patterns_to_try = [
                  f'## {re.escape(section_title)}',  # Exact match
                  f'## .*?{re.escape(section_title.split(maxsplit=1)[-1]) if " " in section_title else section_title}',  # Without emoji
                  r'## ü§ñ Data Science.*?Internship Roles',  # Specific for AI/ML section
              ]
              
              start_match = None
              for pattern in patterns_to_try:
                  start_match = re.search(pattern, content)
                  if start_match:
                      print(f"  Matched with pattern: {pattern[:50]}...")
                      break
              
              if not start_match:
                  print(f"  Section not found!")
                  return ""
              
              start_pos = start_match.start()
              
              # Find next section (starts with ##)
              next_section = re.search(r'\n## ', content[start_pos + 10:])
              if next_section:
                  end_pos = start_pos + 10 + next_section.start()
              else:
                  end_pos = len(content)
              
              section = content[start_pos:end_pos]
              print(f"  Extracted {len(section)} characters")
              return section
          
          def parse_internships_fast(section_content):
              """Parse internship entries - OPTIMIZED VERSION"""
              print("  Parsing internships...")
              internships = set()
              
              # Split into table rows first (much faster)
              rows = section_content.split('<tr>')
              print(f"  Found {len(rows)} rows")
              
              count = 0
              for row in rows[1:]:  # Skip header row
                  # Quick check if this is a main company row (not a ‚Ü≥ continuation)
                  if '‚Ü≥' in row:
                      continue
                  
                  # Must have <strong> tag (company name)
                  if '<strong>' not in row:
                      continue
                  
                  try:
                      # Split row into cells
                      cells = row.split('</td>')
                      if len(cells) < 4:
                          continue
                      
                      # Cell 0: Company (inside <strong> tags)
                      company_cell = cells[0]
                      company_match = re.search(r'<strong><a[^>]*>(.*?)</a></strong>', company_cell)
                      if not company_match:
                          continue
                      company = company_match.group(1).strip()
                      
                      # Cell 1: Role
                      role_cell = cells[1]
                      # Remove all HTML tags
                      role = re.sub(r'<[^>]+>', '', role_cell).strip()
                      if not role:
                          continue
                      
                      # Cell 2: Location
                      location_cell = cells[2]
                      location = re.sub(r'<[^>]+>', ' ', location_cell).strip()
                      location = ' '.join(location.split())  # Normalize whitespace
                      
                      # Cell 3: Application link
                      app_cell = cells[3]
                      link_match = re.search(r'href="([^"]+)"', app_cell)
                      app_link = link_match.group(1).strip() if link_match else ""
                      
                      if company and role:
                          internships.add(f"{company}|{role}|{location}|{app_link}")
                          count += 1
                          if count <= 3:  # Debug: print first 3
                              print(f"    Sample: {company} - {role}")
                  except Exception as e:
                      # Skip malformed rows silently
                      continue
              
              print(f"  Parsed {count} internships")
              return internships
          
          # Extract relevant sections
          print("\n--- Extracting Software Engineering section ---")
          swe_section_old = extract_section(previous_content, "üíª Software Engineering Internship Roles")
          swe_section_new = extract_section(new_content, "üíª Software Engineering Internship Roles")
          
          print("\n--- Extracting AI/ML/DS section ---")
          # Use a flexible pattern that will catch the AI/ML section regardless of exact formatting
          ai_section_old = extract_section(previous_content, "Data Science, AI & Machine Learning Internship Roles")
          ai_section_new = extract_section(new_content, "Data Science, AI & Machine Learning Internship Roles")
          
          # Parse internships
          print("\n--- Parsing Software Engineering internships ---")
          swe_internships_old = parse_internships_fast(swe_section_old)
          swe_internships_new = parse_internships_fast(swe_section_new)
          
          print("\n--- Parsing AI/ML/DS internships ---")
          ai_internships_old = parse_internships_fast(ai_section_old)
          ai_internships_new = parse_internships_fast(ai_section_new)
          
          # Find new internships
          print("\n--- Finding new internships ---")
          new_swe = swe_internships_new - swe_internships_old
          new_ai = ai_internships_new - ai_internships_old
          
          print(f"New SWE: {len(new_swe)}, New AI/ML/DS: {len(new_ai)}")
          
          # Check if there are any new relevant internships
          if new_swe or new_ai:
              print(f"\n‚úÖ Found {len(new_swe)} new SWE internships and {len(new_ai)} new AI/ML/DS internships")
              
              # Format the email body as HTML
              email_body = "<!DOCTYPE html>\n"
              email_body += "<html>\n<head>\n<style>\n"
              email_body += "body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n"
              email_body += ".header { background-color: #4CAF50; color: white; padding: 20px; text-align: center; }\n"
              email_body += ".content { padding: 20px; }\n"
              email_body += ".section { margin-bottom: 30px; }\n"
              email_body += ".job { background-color: #f9f9f9; border-left: 4px solid #4CAF50; padding: 15px; margin-bottom: 15px; }\n"
              email_body += ".job-title { font-weight: bold; font-size: 18px; color: #2c3e50; }\n"
              email_body += ".job-company { color: #16a085; font-size: 16px; }\n"
              email_body += ".job-location { color: #7f8c8d; }\n"
              email_body += ".apply-btn { display: inline-block; background-color: #4CAF50; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; margin-top: 8px; }\n"
              email_body += ".apply-btn:hover { background-color: #45a049; }\n"
              email_body += ".footer { background-color: #f1f1f1; padding: 15px; text-align: center; font-size: 14px; color: #666; }\n"
              email_body += ".stats { background-color: #e8f5e9; padding: 10px; border-radius: 4px; margin: 15px 0; }\n"
              email_body += "</style>\n</head>\n<body>\n"
              email_body += '<div class="header">\n<h1>üéâ New Internship Opportunities!</h1>\n</div>\n\n'
              email_body += '<div class="content">\n'
              email_body += f'<div class="stats">\n'
              email_body += f'<strong>üìÖ Last Updated:</strong> {commit_date}<br>\n'
              email_body += f'<strong>üí¨ Latest Commit:</strong> {commit_message}<br>\n'
              email_body += f'<strong>üîó Commit SHA:</strong> {commit_sha}\n'
              email_body += '</div>\n'
              
              if new_swe:
                  email_body += f'\n<div class="section">\n'
                  email_body += f'<h2>üíª NEW SOFTWARE ENGINEERING ROLES ({len(new_swe)})</h2>\n'
                  
                  for i, internship in enumerate(sorted(new_swe), 1):
                      parts = internship.split('|')
                      company = parts[0]
                      role = parts[1]
                      location = parts[2]
                      app_link = parts[3] if len(parts) > 3 and parts[3] else ""
                      
                      email_body += '<div class="job">\n'
                      email_body += f'<div class="job-company">{i}. {company}</div>\n'
                      email_body += f'<div class="job-title">{role}</div>\n'
                      email_body += f'<div class="job-location">üìç {location}</div>\n'
                      if app_link:
                          email_body += f'<a href="{app_link}" class="apply-btn">Apply Now</a>\n'
                      email_body += '</div>\n'
                  
                  email_body += '</div>\n'
              
              if new_ai:
                  email_body += f'\n<div class="section">\n'
                  email_body += f'<h2>ü§ñ NEW AI/ML/DATA SCIENCE ROLES ({len(new_ai)})</h2>\n'
                  
                  for i, internship in enumerate(sorted(new_ai), 1):
                      parts = internship.split('|')
                      company = parts[0]
                      role = parts[1]
                      location = parts[2]
                      app_link = parts[3] if len(parts) > 3 and parts[3] else ""
                      
                      email_body += '<div class="job">\n'
                      email_body += f'<div class="job-company">{i}. {company}</div>\n'
                      email_body += f'<div class="job-title">{role}</div>\n'
                      email_body += f'<div class="job-location">üìç {location}</div>\n'
                      if app_link:
                          email_body += f'<a href="{app_link}" class="apply-btn">Apply Now</a>\n'
                      email_body += '</div>\n'
                  
                  email_body += '</div>\n'
              
              email_body += '</div>\n\n'
              email_body += '<div class="footer">\n'
              email_body += '<p><a href="https://github.com/SimplifyJobs/Summer2026-Internships">üîó View Full Repository</a></p>\n'
              email_body += f'<p>üìä Total SWE Roles: {len(swe_internships_new)} | Total AI/ML/DS Roles: {len(ai_internships_new)}</p>\n'
              email_body += '<p style="font-size: 12px; color: #999;">This is an automated notification from your GitHub Actions internship monitor.</p>\n'
              email_body += '</div>\n</body>\n</html>\n'
              
              # Save email body to file
              with open('email_body.txt', 'w', encoding='utf-8') as f:
                  f.write(email_body)
              
              # Set output for GitHub Actions
              import os
              github_output = os.getenv('GITHUB_OUTPUT')
              with open(github_output, 'a') as f:
                  f.write('changes_detected=true\n')
                  f.write(f'new_count={len(new_swe) + len(new_ai)}\n')
                  f.write(f'commit_date={commit_date}\n')
          else:
              print("\n‚ùå No new relevant internships found")
              import os
              github_output = os.getenv('GITHUB_OUTPUT')
              with open(github_output, 'a') as f:
                  f.write('changes_detected=false\n')
          
          print("\nAnalysis complete!")
          
          PYTHON_SCRIPT
      
      - name: Send email notification
        if: steps.analyze.outputs.changes_detected == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üö® ${{ steps.analyze.outputs.new_count }} New Summer 2026 Internships!"
          to: ss20355@nyu.edu
          from: Internship Monitor
          html_body: file://email_body.txt
          content_type: text/html
          
      - name: Update stored README
        if: steps.analyze.outputs.changes_detected == 'true'
        run: |
          cp new_readme.md previous_readme.md
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add previous_readme.md
          git commit -m "Update tracked README - ${{ steps.analyze.outputs.new_count }} new internships [skip ci]"
          git push
