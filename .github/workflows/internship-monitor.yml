name: Internship Monitor

on:
  schedule:
    # Runs every hour at minute 0
    - cron: '0 * * * *'
  workflow_dispatch: # Allows manual triggering for testing

jobs:
  check-for-updates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout monitoring repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Fetch latest internship data
        run: |
          # Fetch the README from the internships repository
          curl -H "Accept: application/vnd.github.v3.raw" \
               -o new_readme.md \
               https://api.github.com/repos/SimplifyJobs/Summer2026-Internships/readme
          
          # Fetch the last commit info for the README
          curl -H "Accept: application/vnd.github.v3+json" \
               -o latest_commit.json \
               https://api.github.com/repos/SimplifyJobs/Summer2026-Internships/commits?path=README.md&per_page=1
      
      - name: Analyze changes and detect new internships
        id: analyze
        run: |
          python3 << 'PYTHON_SCRIPT'
          import re
          import json
          import sys
          from datetime import datetime
          
          # Read the previous and new README files
          try:
              with open('previous_readme.md', 'r', encoding='utf-8') as f:
                  previous_content = f.read()
          except FileNotFoundError:
              print("First run - no previous data")
              previous_content = ""
          
          with open('new_readme.md', 'r', encoding='utf-8') as f:
              new_content = f.read()
          
          # Read commit info
          with open('latest_commit.json', 'r') as f:
              commit_data = json.load(f)[0]
              commit_message = commit_data['commit']['message']
              commit_date = commit_data['commit']['author']['date']
              commit_sha = commit_data['sha'][:7]
          
          def extract_section(content, section_title):
              """Extract a specific section from the README"""
              pattern = rf'## {re.escape(section_title)}.*?(?=##|\Z)'
              match = re.search(pattern, content, re.DOTALL)
              return match.group(0) if match else ""
          
          def parse_internships(section_content):
              """Parse internship entries from a section"""
              internships = set()
              # Match table rows with company, role, location, and application link
              # Look for the Apply button link (not the Simplify link)
              pattern = r'<tr>.*?<strong>.*?>(.*?)</a></strong>.*?<td>(.*?)</td>.*?<td>(.*?)</td>.*?<td>.*?href="(.*?)".*?Apply.*?</td>'
              matches = re.finditer(pattern, section_content, re.DOTALL)
              
              for match in matches:
                  company = re.sub(r'<.*?>', '', match.group(1)).strip()
                  role = re.sub(r'<.*?>', '', match.group(2)).strip()
                  location = re.sub(r'<.*?>', '', match.group(3)).strip()
                  location = re.sub(r'</br>', ', ', location)
                  app_link = match.group(4).strip()
                  
                  # Skip empty or malformed entries
                  if company and role and not role.startswith('â†³') and app_link:
                      internships.add(f"{company}|{role}|{location}|{app_link}")
              
              return internships
          
          # Extract relevant sections
          swe_section_old = extract_section(previous_content, "ðŸ’» Software Engineering Internship Roles")
          swe_section_new = extract_section(new_content, "ðŸ’» Software Engineering Internship Roles")
          
          ai_section_old = extract_section(previous_content, "ðŸ¤– Data Science, AI & Machine Learning Internship Roles")
          ai_section_new = extract_section(new_content, "ðŸ¤– Data Science, AI & Machine Learning Internship Roles")
          
          # Parse internships
          swe_internships_old = parse_internships(swe_section_old)
          swe_internships_new = parse_internships(swe_section_new)
          
          ai_internships_old = parse_internships(ai_section_old)
          ai_internships_new = parse_internships(ai_section_new)
          
          # Find new internships
          new_swe = swe_internships_new - swe_internships_old
          new_ai = ai_internships_new - ai_internships_old
          
          # Check if there are any new relevant internships
          if new_swe or new_ai:
              print(f"Found {len(new_swe)} new SWE internships and {len(new_ai)} new AI/ML/DS internships")
              
              # Format the email body
              email_body = f"ðŸŽ‰ New internship opportunities have been posted!\n\n"
              email_body += f"ðŸ“… Last Updated: {commit_date}\n"
              email_body += f"ðŸ’¬ Latest Commit: {commit_message}\n"
              email_body += f"ðŸ”— Commit SHA: {commit_sha}\n\n"
              
              if new_swe:
                  email_body += f"ðŸ’» NEW SOFTWARE ENGINEERING ROLES ({len(new_swe)}):\n"
                  email_body += "=" * 70 + "\n\n"
                  for i, internship in enumerate(sorted(new_swe), 1):
                      parts = internship.split('|')
                      company, role, location, app_link = parts[0], parts[1], parts[2], parts[3] if len(parts) == 4 else ""
                      email_body += f"{i}. {company}\n"
                      email_body += f"   Role: {role}\n"
                      email_body += f"   Location: {location}\n"
                      if app_link:
                          email_body += f"   ðŸ”— Apply: {app_link}\n"
                      email_body += "\n"
              
              if new_ai:
                  email_body += f"\nðŸ¤– NEW AI/ML/DATA SCIENCE ROLES ({len(new_ai)}):\n"
                  email_body += "=" * 70 + "\n\n"
                  for i, internship in enumerate(sorted(new_ai), 1):
                      parts = internship.split('|')
                      company, role, location, app_link = parts[0], parts[1], parts[2], parts[3] if len(parts) == 4 else ""
                      email_body += f"{i}. {company}\n"
                      email_body += f"   Role: {role}\n"
                      email_body += f"   Location: {location}\n"
                      if app_link:
                          email_body += f"   ðŸ”— Apply: {app_link}\n"
                      email_body += "\n"
              
              email_body += "\n" + "=" * 70 + "\n"
              email_body += "ðŸ”— View full repository: https://github.com/SimplifyJobs/Summer2026-Internships\n"
              email_body += f"ðŸ“Š Total SWE roles: {len(swe_internships_new)} | Total AI/ML/DS roles: {len(ai_internships_new)}\n"
              
              # Save email body to file
              with open('email_body.txt', 'w', encoding='utf-8') as f:
                  f.write(email_body)
              
              # Set output for GitHub Actions
              with open('$GITHUB_OUTPUT', 'a') as f:
                  f.write('changes_detected=true\n')
                  f.write(f'new_count={len(new_swe) + len(new_ai)}\n')
                  f.write(f'commit_date={commit_date}\n')
          else:
              print("No new relevant internships found")
              with open('$GITHUB_OUTPUT', 'a') as f:
                  f.write('changes_detected=false\n')
          
          PYTHON_SCRIPT
      
      - name: Send email notification
        if: steps.analyze.outputs.changes_detected == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸš¨ ${{ steps.analyze.outputs.new_count }} New Summer 2026 Internships!"
          to: ss20355@nyu.edu
          from: Internship Monitor
          body: file://email_body.txt
          
      - name: Update stored README
        if: steps.analyze.outputs.changes_detected == 'true'
        run: |
          cp new_readme.md previous_readme.md
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add previous_readme.md
          git commit -m "Update tracked README - ${{ steps.analyze.outputs.new_count }} new internships [skip ci]"
          git push
